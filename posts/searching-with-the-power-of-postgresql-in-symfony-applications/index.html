<!doctype html><html><head lang=en><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Searching with the power of postgresql in symfony applications - @ozgurvurgun</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="For instance, you need to write a search page for your last project, and it is not big enough to use an external search engine. Still, you want to use some powerful text searching features. You are brilliant if you preferred PostgreSQL as your database. Because PostgreSQL has very, very powerful search capabilities. I want to share some of them with you."><meta property="og:image" content><meta property="og:title" content="Searching with the power of postgresql in symfony applications"><meta property="og:description" content="For instance, you need to write a search page for your last project, and it is not big enough to use an external search engine. Still, you want to use some powerful text searching features. You are brilliant if you preferred PostgreSQL as your database. Because PostgreSQL has very, very powerful search capabilities. I want to share some of them with you."><meta property="og:type" content="article"><meta property="og:url" content="https://ozgurvurgun.github.io/posts/searching-with-the-power-of-postgresql-in-symfony-applications/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-06-15T00:00:00+00:00"><meta property="article:modified_time" content="2020-06-15T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Searching with the power of postgresql in symfony applications"><meta name=twitter:description content="For instance, you need to write a search page for your last project, and it is not big enough to use an external search engine. Still, you want to use some powerful text searching features. You are brilliant if you preferred PostgreSQL as your database. Because PostgreSQL has very, very powerful search capabilities. I want to share some of them with you."><script src=https://ozgurvurgun.github.io/js/feather.min.js></script>
<link href=https://ozgurvurgun.github.io/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://ozgurvurgun.github.io/css/main.6a0f23ea50fd34b46fee262a5a68e17d458c51a2bc99ba1ba018065de6b180c3.css><link id=darkModeStyle rel=stylesheet type=text/css href=https://ozgurvurgun.github.io/css/dark.50b57e12d401420df23965fed157368aba37b76df0ecefd0b1ecd4da664f01a0.css media="(prefers-color-scheme: dark)"><script async src="https://www.googletagmanager.com/gtag/js?id=G-VLZVJMKPNJ"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-VLZVJMKPNJ")</script></head><body><div class=content><header><div class=main><a href=https://ozgurvurgun.github.io/>@ozgurvurgun</a></div><nav><a href=/>main</a>
<a href=https://gist.github.com/ozgurvurgun>gist</a>
<a href=/about>me</a>
<a href=/subscribe>subscribe</a></nav></header><main><article><div class=post-container><div class=post-content><div class=title><h1 class=title>Searching with the power of postgresql in symfony applications</h1><div class=meta>Posted on Jun 15, 2020</div></div><section class=body><p>For instance, you need to write a search page for your last project, and it is not big enough to use an external search engine. Still, you want to use some powerful text searching features. You are brilliant if you preferred PostgreSQL as your database. Because PostgreSQL has very, very powerful search capabilities. I want to share some of them with you.</p><p>You can run the search queries on columns even if you don&rsquo;t index it. You need a <code>document</code> and a <code>query</code> for running on it. There is an operator for running your search query over the document. It is <code>@@</code>!</p><p>For instance; you have a content table like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>create</span> <span style=color:#66d9ef>table</span> content( id INT, title TEXT, body TEXT);
</span></span></code></pre></div><p>And, it includes some data;</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>insert</span> <span style=color:#66d9ef>into</span> content <span style=color:#66d9ef>values</span>(<span style=color:#ae81ff>1</span>,<span style=color:#e6db74>&#39;Demo content&#39;</span>, <span style=color:#e6db74>&#39;Demo content body &#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>insert</span> <span style=color:#66d9ef>into</span> content <span style=color:#66d9ef>values</span>(<span style=color:#ae81ff>2</span>,<span style=color:#e6db74>&#39;Demo content 2&#39;</span>, <span style=color:#e6db74>&#39;Demo content body2 &#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>insert</span> <span style=color:#66d9ef>into</span> content <span style=color:#66d9ef>values</span>(<span style=color:#ae81ff>3</span>,<span style=color:#e6db74>&#39;Verification title&#39;</span>, <span style=color:#e6db74>&#39;Virtualization on cloud&#39;</span>);
</span></span></code></pre></div><p>Let&rsquo;s run a search query on this table. Like I said, &ldquo;We need a document and a query.&rdquo; But we do not index anything yet, and we not have any query typed data. So, we can use the <code>to_tsvector</code> function for creating our document on the fly, and we can use the <code>to_tsquery</code> function for creating our query on the fly.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>select</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>from</span> content <span style=color:#66d9ef>where</span> to_tsvector(title) <span style=color:#f92672>@@</span> to_tsquery(<span style=color:#e6db74>&#39;demo&#39;</span>);
</span></span></code></pre></div><p>And the result is;</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span> id |     title      |        body
</span></span><span style=display:flex><span>----+----------------+---------------------
</span></span><span style=display:flex><span>  1 | Demo content   | Demo content body
</span></span><span style=display:flex><span>  2 | Demo content 2 | Demo content body2
</span></span><span style=display:flex><span>(2 rows)
</span></span></code></pre></div><p>Meh, it was so easy. Let&rsquo;s try another thing. Did you see our last data? It includes <em>Verification</em> text inside. Can we search for it with any variant of the words? Yes, of course. For example, &ldquo;Verify&rdquo;.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>select</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>from</span> content <span style=color:#66d9ef>where</span> to_tsvector(title) <span style=color:#f92672>@@</span> to_tsquery(<span style=color:#e6db74>&#39;verify&#39;</span>);
</span></span></code></pre></div><p>Get it? We can search for variants. PostgreSQL knows which word is matching with which words.</p><p>Also, there is a lot of special features here. You can read about it in the official documentation. This is not a documentation dude, this is a blog post. Just I&rsquo;ve noted the amazing things not documenting. Anyway, this is the documentation URL: <a href=https://www.postgresql.org/docs/9.1/datatype-textsearch.html>postgresql/textsearch</a></p><p>OK. Let&rsquo;s continue.</p><p>I said you need to have a document and a query. So, you can create a document using different fields if you want. You can use <code>||</code> operator for concatenation.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>select</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>from</span> content <span style=color:#66d9ef>where</span> to_tsvector(title <span style=color:#f92672>||</span> <span style=color:#e6db74>&#39; &#39;</span> <span style=color:#f92672>||</span> body) <span style=color:#f92672>@@</span> to_tsquery(<span style=color:#e6db74>&#39;cloud&#39;</span>);
</span></span></code></pre></div><p>Also, you need a correct query for searching. So, you can&rsquo;t use this <code>to_tsquery('verification cloud')</code> because it is not valid. The query must not include spaces. It must be a logical operation. So? You can split your text and merge it via <em>and</em> or <em>or</em>. Like this: <code>to_tsquery('cloud&amp;verification')</code> or <code>to_tsquery('cloud|demo')</code></p><p>You like that, right?</p><p>&ndash;</p><p>OK. Let&rsquo;s jump the Symfony section. We have the Doctrine. Great ORM. But sometimes it can disable us. Like now&mldr;</p><p>We need to use a native query to make a profit about searching. I tired while writing. I&rsquo;m adding the example here. This is a very basic snippet.</p><p>Note:I&rsquo;m using <code>$rsm->generateSelectClause()</code> for prevent collisions happened when working with multiple tables.</p><p>Attention: This is an example code. Please filter your <code>$query</code> to prevent your application from an SQL injection vulnerability.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>search</span>(<span style=color:#a6e22e>string</span> $query,<span style=color:#f92672>?</span><span style=color:#a6e22e>string</span> $role<span style=color:#f92672>=</span><span style=color:#66d9ef>null</span>)
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>   $query <span style=color:#f92672>=</span> (<span style=color:#66d9ef>function</span>($q){
</span></span><span style=display:flex><span>       $pieces <span style=color:#f92672>=</span> <span style=color:#a6e22e>explode</span>(<span style=color:#e6db74>&#39; &#39;</span>,$q);
</span></span><span style=display:flex><span>       <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>join</span>(<span style=color:#e6db74>&#39;&amp;&#39;</span>,$pieces);
</span></span><span style=display:flex><span>    })($query);
</span></span><span style=display:flex><span>    $rsm <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>ResultSetMappingBuilder</span>($this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>_em</span>,<span style=color:#a6e22e>ResultSetMappingBuilder</span><span style=color:#f92672>::</span><span style=color:#a6e22e>COLUMN_RENAMING_INCREMENT</span>);
</span></span><span style=display:flex><span>    $rsm<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>addRootEntityFromClassMetadata</span>(<span style=color:#e6db74>&#39;App\\Entity\\User&#39;</span>, <span style=color:#e6db74>&#39;m&#39;</span>);
</span></span><span style=display:flex><span>    $rsm<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>addJoinedEntityFromClassMetadata</span>(<span style=color:#e6db74>&#39;App\\Entity\\Profile&#39;</span>, <span style=color:#e6db74>&#39;p&#39;</span>,<span style=color:#e6db74>&#39;m&#39;</span>,<span style=color:#e6db74>&#39;profile&#39;</span>);
</span></span><span style=display:flex><span>    $sql <span style=color:#f92672>=</span><span style=color:#e6db74>&#34;select &#34;</span><span style=color:#f92672>.</span>$rsm<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>generateSelectClause</span>()<span style=color:#f92672>.</span><span style=color:#e6db74>&#34; from member m 
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      inner join profile p on m.profile_id=p.id
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      where to_tsvector(m.email || &#39; &#39; || p.prename || &#39; &#39; || p.lastname || &#39; &#39; || p.company || &#39; &#39; || p.position) @@ to_tsquery(&#39;</span><span style=color:#e6db74>$query</span><span style=color:#e6db74>&#39;)&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span>($role) {
</span></span><span style=display:flex><span>      $sql<span style=color:#f92672>.=</span><span style=color:#e6db74>&#34; AND &#39;</span><span style=color:#e6db74>$role</span><span style=color:#e6db74>&#39; = ANY (roles)&#34;</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    $qb <span style=color:#f92672>=</span> $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>_em</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>createNativeQuery</span>($sql,$rsm);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> $qb<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>getResult</span>();
</span></span><span style=display:flex><span>  }
</span></span></code></pre></div><p>Keep safe&mldr;</p></section><div class=post-tags></div></div></div></article></main><footer><div style=display:flex><a class=soc href=https://github.com/ozgurvurgun rel=me title=GitHub><i data-feather=github></i></a>
<a class=border></a><a class=soc href=https://linkedin.com/in/ozgurvurgun1 rel=me title=Linkedin><i data-feather=linkedin></i></a>
<a class=border></a><a class=soc href=http://emre.xyz/me.vcf rel=me title=VCF><i data-feather=phone></i></a>
<a class=border></a><a class=soc href=http://emre.xyz/resume.pdf rel=me title=Resume><i data-feather=file-text></i></a>
<a class=border></a></div><div class=footer-info>2025 ozgurvurgun | <a href=https://github.com/athul/archie>Archie Theme</a> | Built with <a href=https://gohugo.io>Hugo</a></div></footer><script>feather.replace()</script></div></body></html>