<!doctype html><html><head lang=en><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Lets write a custom function to doctrine - @ozgurvurgun</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Doctrine is well-known ORM for php applications, especially apps which uses #symfony framework. I like to use symfony when i need to write a php application in all scale.
Doctrine is fittest ORM for sql operation in #PHP ecosystem in my opinion. I want to talk about writing custom #dql functions for doctrine."><meta property="og:image" content><meta property="og:title" content="Lets write a custom function to doctrine"><meta property="og:description" content="Doctrine is well-known ORM for php applications, especially apps which uses #symfony framework. I like to use symfony when i need to write a php application in all scale.
Doctrine is fittest ORM for sql operation in #PHP ecosystem in my opinion. I want to talk about writing custom #dql functions for doctrine."><meta property="og:type" content="article"><meta property="og:url" content="https://ozgurvurgun.github.io/posts/lets-write-a-custom-function-to-doctrine/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-01-27T00:00:00+00:00"><meta property="article:modified_time" content="2022-01-27T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Lets write a custom function to doctrine"><meta name=twitter:description content="Doctrine is well-known ORM for php applications, especially apps which uses #symfony framework. I like to use symfony when i need to write a php application in all scale.
Doctrine is fittest ORM for sql operation in #PHP ecosystem in my opinion. I want to talk about writing custom #dql functions for doctrine."><script src=https://ozgurvurgun.github.io/js/feather.min.js></script>
<link href=https://ozgurvurgun.github.io/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://ozgurvurgun.github.io/css/main.6a0f23ea50fd34b46fee262a5a68e17d458c51a2bc99ba1ba018065de6b180c3.css><link id=darkModeStyle rel=stylesheet type=text/css href=https://ozgurvurgun.github.io/css/dark.50b57e12d401420df23965fed157368aba37b76df0ecefd0b1ecd4da664f01a0.css media="(prefers-color-scheme: dark)"><script async src="https://www.googletagmanager.com/gtag/js?id=G-VLZVJMKPNJ"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-VLZVJMKPNJ")</script></head><body><div class=content><header><div class=main><a href=https://ozgurvurgun.github.io/>@ozgurvurgun</a></div><nav><a href=/>main</a>
<a href=https://gist.github.com/ozgurvurgun>gist</a>
<a href=/about>me</a>
<a href=/subscribe>subscribe</a></nav></header><main><article><div class=post-container><div class=post-content><div class=title><h1 class=title>Lets write a custom function to doctrine</h1><div class=meta>Posted on Jan 27, 2022</div></div><section class=body><p>Doctrine is well-known ORM for php applications, especially apps which uses #symfony framework. I like to use symfony when i need to write a php application in all scale.</p><p>Doctrine is fittest ORM for sql operation in #PHP ecosystem in my opinion. I want to talk about writing custom #dql functions for doctrine.</p><p>Often i have need to use native #postgresql functions in my apps, like <code>json_equality</code>function that i created. I use that function like this <code>json_equality(table.jsoncolumn,'fieldname_injsoncolumn','subfield_injsoncolumn')</code> and it will generate that sql <code>table.column -> 'fielname_injsoncolumn' ->> 'subfield_injsoncolumn'</code> and the postgres will look json column for correct equation.</p><p>First, let&rsquo;s understand how it works. But, i will not go deep, if you interested you can learn about what is AST.</p><p>Doctrine have a parser for queries, it will parse what you write as query and then it will convert everything to sql queries. So, its not same what you write in your php code with sql queries. For example;</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span>$qb <span style=color:#f92672>=</span> $em<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>createQuery</span>(<span style=color:#e6db74>&#39;SELECT u FROM App\Entity\User WHERE u.id = 3&#39;</span>);
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> u <span style=color:#66d9ef>FROM</span> <span style=color:#66d9ef>user</span> u <span style=color:#66d9ef>WHERE</span> u.id<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span>
</span></span></code></pre></div><p>Look at the above. These two thing contains similar terms, <code>SELECT</code> , <code>FROM</code>,<code>WHERE</code>, maybe you are thinking these are same, but NOT. First ones are just like placeholders, they are DQL statements, orm will change everything inside the query to SQL statements.</p><p>Like this, when you write <code>SELECT u FROM App\Entity\User WHERE json_equality(u.metadata,'social','allow_to_follow') = 1</code> query, doctrine will parse it and convert to that <code>SELECT u FROM user u WHERE CAST (u.metadata -> 'social' ->> 'allow_to_follow' AS INTEGER) = 1</code> query.</p><pre><code>i assume you know json operators on postgres, if not, you can read documentation
</code></pre><p>Ok. Let&rsquo;s write some code.</p><p>We have to create <code>JsonEquality</code> class which extends from <code>Doctrine\ORM\Query\AST\Functions\FunctionNode</code> class and that class will be placed in <code>src/Doctrine/ORM/Query/AST/Functions/JsonEquality.php</code> file.</p><p>It will have two methods. First method name is <code>parse</code> and it will take one argument, its <code>Doctrine\ORM\Query\Parser</code>. We will use that argument to parse the part of the query. Second method name is <code>getSql</code> and it will take one argument, its <code>Doctrine\ORM\Query\SqlWalker</code>. We will use that argument to start parsing to part of query and will return part of the SQL query.</p><p>Also we need two properties on that class to store parsed values in <code>parse</code> method and then use those properties in <code>getSql</code> method. It will be private:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#66d9ef>private</span> $field;
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> $json_fields<span style=color:#f92672>=</span>[];
</span></span></code></pre></div><p>In the <code>parse</code> method, we will parse the part of the DQL query. Variable name is <code>$parser</code> for argument of method. And this parser have a method named <code>match</code> it will wait for a <code>token</code> to match, and it will walk through on the query until next token match or node match (wtf is the node? you can read about AST, seriously!). Also there is a ton of methods to generate predefined tokens, like <code>StringPrimary</code> method for string matches, <code>AritmeticExpression</code> for more complex expressions and subqueries. There is also another method exists in <code>Parser</code> object.</p><p>We can write first section.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>parse</span>(<span style=color:#a6e22e>Parser</span> $parser)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	$parser<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>match</span>(<span style=color:#a6e22e>Lexer</span><span style=color:#f92672>::</span><span style=color:#a6e22e>T_IDENTIFIER</span>); <span style=color:#75715e>//its our identifier json_equality
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	$parser<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>match</span>(<span style=color:#a6e22e>Lexer</span><span style=color:#f92672>::</span><span style=color:#a6e22e>T_OPEN_PARENTHESIS</span>);
</span></span><span style=display:flex><span>	$this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>field</span> <span style=color:#f92672>=</span> $parser<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>StringPrimary</span>(); <span style=color:#75715e>//we are storing first argument of json_equality function as property. This is not the calue, its node of the first value. We will use that in getSql method.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	$parser<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>match</span>(<span style=color:#a6e22e>Lexer</span><span style=color:#f92672>::</span><span style=color:#a6e22e>T_COMMA</span>); <span style=color:#75715e>//this is the comma after first argument
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Let&rsquo;s stop here and think a little. Our function requires how many arguments? We saw three in example <code>json_equality(table.userdata,'user','firstname')</code> but it may be less; <code>json_equality(table.userdata,'username')</code> or it may be more; <code>json_equality(table.userdata,'comments','counts','favorite')</code>, then how we can handle dynamic lenght in arguments? There is no argument spreading feature in DQL. So? Maybe we can try another approach;</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>parse</span>(<span style=color:#a6e22e>Parser</span> $parser)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span><span style=color:#75715e>//...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	$this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>field</span> <span style=color:#f92672>=</span> $parser<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>StringPrimary</span>();
</span></span><span style=display:flex><span>	$lexer <span style=color:#f92672>=</span> $parser<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>getLexer</span>(); <span style=color:#75715e>//we will use it to look to the type of the current token
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>while</span>(<span style=color:#a6e22e>count</span>($this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>json_fields</span>)<span style=color:#f92672>&lt;</span><span style=color:#ae81ff>1</span> <span style=color:#f92672>||</span> $lexer<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>lookahead</span>[<span style=color:#e6db74>&#39;type&#39;</span>] <span style=color:#f92672>!=</span> <span style=color:#a6e22e>Lexer</span><span style=color:#f92672>::</span><span style=color:#a6e22e>T_CLOSE_PARENTHESIS</span>) { <span style=color:#75715e>//loop until reach the close paranthesis
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>     $parser<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>match</span>(<span style=color:#a6e22e>Lexer</span><span style=color:#f92672>::</span><span style=color:#a6e22e>T_COMMA</span>); <span style=color:#75715e>//walk over comma
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>     $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>json_fields</span>[]<span style=color:#f92672>=</span> $parser<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>ArithmeticExpression</span>(); <span style=color:#75715e>//add new node to array property
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>   }
</span></span><span style=display:flex><span>	$parser<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>match</span>(<span style=color:#a6e22e>Lexer</span><span style=color:#f92672>::</span><span style=color:#a6e22e>T_CLOSE_PARENTHESIS</span>);<span style=color:#75715e>//walk over close parenthesis and complete the parsing
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>Thats it! Our <code>parse</code> method is done and also have dynamic sized argument support.</p><p>We can contunie to generate SQL code.</p><p>In the <code>getSql</code> method, we need just <code>dispatch</code> method of nodes. It will take value of the node and we will assign to variables, and we will use to generate SQL code.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#75715e>//lets assume our dql is json_equality(table.userdata,&#39;user&#39;,&#39;firstname&#39;)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>getSql</span>(<span style=color:#a6e22e>SqlWalker</span> $sqlWalker)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	$field <span style=color:#f92672>=</span> $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>field</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>dispatch</span>($sqlWalker); <span style=color:#75715e>//get value from node, it will be table.userdata
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	$values <span style=color:#f92672>=</span> []; <span style=color:#75715e>// it will store json fields
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span>($i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; $i<span style=color:#f92672>&lt;</span><span style=color:#a6e22e>count</span>($this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>json_fields</span>); $i<span style=color:#f92672>++</span>){
</span></span><span style=display:flex><span>	 $values[]<span style=color:#f92672>=</span>$this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>json_fields</span>[$i]<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>dispatch</span>($sqlWalker); <span style=color:#75715e>// we have to dispatch all fields and push values to $values array
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	}
</span></span><span style=display:flex><span>	$lastValue<span style=color:#f92672>=</span> <span style=color:#a6e22e>array_pop</span>($values); <span style=color:#75715e>//we are cutting the last element of the values array. We will use that just after -&gt;&gt; oparator, others will be use -&gt; operator. 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>count</span>($values)<span style=color:#f92672>&gt;</span><span style=color:#ae81ff>1</span>){
</span></span><span style=display:flex><span>	 $json <span style=color:#f92672>=</span> <span style=color:#a6e22e>join</span>(<span style=color:#e6db74>&#39; -&gt; &#39;</span>,$values)<span style=color:#f92672>.</span><span style=color:#e6db74>&#39; -&gt;&gt; &#39;</span><span style=color:#f92672>.</span>$lastValue;
</span></span><span style=display:flex><span>	}<span style=color:#66d9ef>else</span>{
</span></span><span style=display:flex><span>	 $json <span style=color:#f92672>=</span> <span style=color:#a6e22e>array_pop</span>($values)<span style=color:#f92672>.</span><span style=color:#e6db74>&#39; -&gt;&gt; &#39;</span><span style=color:#f92672>.</span>$lastValue;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#75715e>//and return generated SQL. In here i create for integer values, you can make it works for your needs. 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>sprintf</span>(
</span></span><span style=display:flex><span>	 <span style=color:#e6db74>&#39;CAST (%s -&gt; %s AS INTEGER)&#39;</span>, $field, $json
</span></span><span style=display:flex><span>	);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Cool, right? But wait! How can use it?</p><p>It must be registered in <code>config/packages/doctrine.yaml</code> file, or you can register via php for non-symfony apps. <a href=https://www.doctrine-project.org/projects/doctrine-orm/en/2.9/cookbook/dql-user-defined-functions.html#dql-user-defined-functions>Check the documentation</a>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>doctrine</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>orm</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>string_functions</span>:
</span></span><span style=display:flex><span>	  <span style=color:#f92672>json_equality</span>: <span style=color:#e6db74>&#39;App\Doctrine\ORM\Query\AST\Functions\JsonEquality&#39;</span>
</span></span></code></pre></div><p>Now you can use it in your code.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span>$qb <span style=color:#f92672>=</span> $this<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>createQueryBuilder</span>(<span style=color:#e6db74>&#39;u&#39;</span>);
</span></span><span style=display:flex><span>$qb<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>andWhere</span>(<span style=color:#e6db74>&#34;json_equality(u.metadata,&#39;social&#39;,&#39;follow_count&#39;) = 100&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>echo</span> $qb<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>getQuery</span>()<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>getSQL</span>();
</span></span></code></pre></div><p>And the result;</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> <span style=color:#66d9ef>user</span> <span style=color:#66d9ef>WHERE</span> <span style=color:#66d9ef>CAST</span>( u.metadata <span style=color:#f92672>-&gt;</span> <span style=color:#e6db74>&#39;social&#39;</span> <span style=color:#f92672>-&gt;&gt;</span> <span style=color:#e6db74>&#39;follow_count&#39;</span> <span style=color:#66d9ef>AS</span> INTEGER) <span style=color:#f92672>=</span> <span style=color:#ae81ff>100</span>;
</span></span></code></pre></div><p>Happy coding!</p><p>#php #symfony #english #web #doctrine</p></section><div class=post-tags></div></div></div></article></main><footer><div style=display:flex><a class=soc href=https://github.com/ozgurvurgun rel=me title=GitHub><i data-feather=github></i></a>
<a class=border></a><a class=soc href=https://linkedin.com/in/ozgurvurgun1 rel=me title=Linkedin><i data-feather=linkedin></i></a>
<a class=border></a><a class=soc href=http://emre.xyz/me.vcf rel=me title=VCF><i data-feather=phone></i></a>
<a class=border></a><a class=soc href=http://emre.xyz/resume.pdf rel=me title=Resume><i data-feather=file-text></i></a>
<a class=border></a></div><div class=footer-info>2025 ozgurvurgun | <a href=https://github.com/athul/archie>Archie Theme</a> | Built with <a href=https://gohugo.io>Hugo</a></div></footer><script>feather.replace()</script></div></body></html>