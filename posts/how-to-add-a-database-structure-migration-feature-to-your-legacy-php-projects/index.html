<!doctype html><html><head lang=en><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>How to add a database structure migration feature to your legacy php projects - @ozgurvurgun</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="There is a ton of legacy projects that exist in the universe written in PHP. Old codebases are hard to maintain, and it&rsquo;s not easy to set up a development environment for legacy applications. I had the same issue; I have a lot of solutions to build a stateless development environment for legacy projects. Today I will focus on database-related one."><meta property="og:image" content><meta property="og:title" content="How to add a database structure migration feature to your legacy php projects"><meta property="og:description" content="There is a ton of legacy projects that exist in the universe written in PHP. Old codebases are hard to maintain, and it&rsquo;s not easy to set up a development environment for legacy applications. I had the same issue; I have a lot of solutions to build a stateless development environment for legacy projects. Today I will focus on database-related one."><meta property="og:type" content="article"><meta property="og:url" content="https://ozgurvurgun.github.io/posts/how-to-add-a-database-structure-migration-feature-to-your-legacy-php-projects/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-08-17T00:00:00+00:00"><meta property="article:modified_time" content="2022-08-17T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="How to add a database structure migration feature to your legacy php projects"><meta name=twitter:description content="There is a ton of legacy projects that exist in the universe written in PHP. Old codebases are hard to maintain, and it&rsquo;s not easy to set up a development environment for legacy applications. I had the same issue; I have a lot of solutions to build a stateless development environment for legacy projects. Today I will focus on database-related one."><script src=https://ozgurvurgun.github.io/js/feather.min.js></script>
<link href=https://ozgurvurgun.github.io/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://ozgurvurgun.github.io/css/main.6a0f23ea50fd34b46fee262a5a68e17d458c51a2bc99ba1ba018065de6b180c3.css><link id=darkModeStyle rel=stylesheet type=text/css href=https://ozgurvurgun.github.io/css/dark.50b57e12d401420df23965fed157368aba37b76df0ecefd0b1ecd4da664f01a0.css media="(prefers-color-scheme: dark)"><script async src="https://www.googletagmanager.com/gtag/js?id=G-VLZVJMKPNJ"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-VLZVJMKPNJ")</script></head><body><div class=content><header><div class=main><a href=https://ozgurvurgun.github.io/>@ozgurvurgun</a></div><nav><a href=/>main</a>
<a href=https://gist.github.com/ozgurvurgun>gist</a>
<a href=/about>me</a>
<a href=/subscribe>subscribe</a></nav></header><main><article><div class=post-container><div class=post-content><div class=title><h1 class=title>How to add a database structure migration feature to your legacy php projects</h1><div class=meta>Posted on Aug 17, 2022</div></div><section class=body><p>There is a ton of legacy projects that exist in the universe written in PHP. Old codebases are hard to maintain, and it&rsquo;s not easy to set up a development environment for legacy applications. I had the same issue; I have a lot of solutions to build a stateless development environment for legacy projects. Today I will focus on database-related one.</p><p>Let&rsquo;s think you start to work on a legacy project and have made some changes to the database on your local. What do you need to do? You will probably fetch the production database to your local (with/without data), write some SQL to alter your DB structure, save queries, and apply them to your production database.</p><p>It&rsquo;s a simple task if you have a simple application. But web applications are mostly like living organisms. Invariably they will be getting more and more complex. You will sometimes forget to apply a statement to your production database. It will cause many problems until you realize which statement you forgot.</p><p>There is a solution for following the structural database changes. It&rsquo;s called <a href=https://en.wikipedia.org/wiki/Schema_migration>Schema Migration</a>. You can start to use a migration library to follow database structure changes. Also, you can go future and past in your DB schema with a migration tool (be careful, it will remove all data dependent in that update if you go back. it will remove field data if you remove a field.)</p><p>Migration libraries mostly have simple logic. You will have versioned up and down scripts, and it will run those scripts. But it may be hard to add libraries to legacy apps.</p><p>So, I created a library for the same purpose. Other libraries are too big and complex; I built a library on top of the PDO library, which has a few simple commands. I want to show you how you can add that library to your <code>legacy</code> app and start to use it.
Let&rsquo;s begin.</p><p>The library name is <a href=https://github.com/7Cups/migratos><code>Migratos</code></a>, its a god of all migration libraries :)</p><p>You can install with <code>composer require 7cups/migratos</code> command. But you will need to create a wrapper for that. Eventually, it&rsquo;s just a library.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>#console.php
</span></span><span style=display:flex><span>&lt;?php
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>require_once(__DIR__.&#39;/vendor/autoload.php&#39;);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>use SevenCupsMigratos\Command\MigrationCommand;
</span></span><span style=display:flex><span>use Symfony\Component\Console\Application;
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$db = new PDO(&#39;mysql:host=localhost;dbname=test&#39;, &#39;databaseuser&#39;, &#39;databaseuserpass&#39;); 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$application = new Application(&#39;My Console&#39;,&#39;1.0&#39;);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$application-&gt;add(new MigrationCommand($db)); 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$application-&gt;run();
</span></span></code></pre></div><p>Migratos only care for PDO instances. Maybe you have a wrapper library over PDO; it will work if extended from PDO.</p><p>We loaded our application autoloader (which was generated by the composer) and then created our PDO instance; then, we will add a migration command to CLI application. (It is using symfony/command library to manage CLI, you can use MigrationCommand with your console app if you have one)</p><p>But before, do not forget to create a folder named <code>migration</code> in your root directory. <code>mkdir migration</code></p><p>Then we just run the CLI app.</p><p>Let&rsquo;s do some tests. You can run that command: <code>php console.php --help</code>.
You will get help text of usage of symfony/console. Then you can run the <code>php console.php list</code> command to get what tools exist in the console.php, and you will see that <code>app:migration</code> subcommand.</p><p>Lets test this: <code>php console.php app:migration --help</code>. There are five options that exist for use with that subcommand.</p><p>At the first usage, you will need a base.sql file. Because you have a database schema already. Try <code>php console.php -b</code> command. It will ask to write a new SQL file with some content. Answer yes. In that step, only the migration table create statement exists in base.sql file.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>#base.sql
</span></span><span style=display:flex><span> CREATE TABLE migratos_migration_versions (
</span></span><span style=display:flex><span>    id int(11) NOT NULL AUTO_INCREMENT,
</span></span><span style=display:flex><span>    version int(11),
</span></span><span style=display:flex><span>    run_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
</span></span><span style=display:flex><span>    direction ENUM(&#39;u&#39;,&#39;d&#39;),
</span></span><span style=display:flex><span>    current_version varchar(255),
</span></span><span style=display:flex><span>    PRIMARY KEY (id)
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><p>Now, you have to export your database structure manually (I will add an automated base.sql creation soon), then paste the content of that file. Let&rsquo;s say we have just a table; then, our base.sql will look like this;</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>#base.sql
</span></span><span style=display:flex><span> CREATE TABLE migratos_migration_versions (
</span></span><span style=display:flex><span>    id int(11) NOT NULL AUTO_INCREMENT,
</span></span><span style=display:flex><span>    version int(11),
</span></span><span style=display:flex><span>    run_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
</span></span><span style=display:flex><span>    direction ENUM(&#39;u&#39;,&#39;d&#39;),
</span></span><span style=display:flex><span>    current_version varchar(255),
</span></span><span style=display:flex><span>    PRIMARY KEY (id)
</span></span><span style=display:flex><span>);
</span></span><span style=display:flex><span>CREATE TABLE IF NOT EXISTS users(
</span></span><span style=display:flex><span>   id int(11) NOT NULL AUTO_INCREMENT,
</span></span><span style=display:flex><span>   username varchar(255),
</span></span><span style=display:flex><span>   type ENUM(&#39;admin&#39;,&#39;member&#39;),
</span></span><span style=display:flex><span>   password varchar(255),
</span></span><span style=display:flex><span>   PRIMARY KEY (id)
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><p>You see. This is our base database structure. But do not forget to add <code>IF NOT EXISTS</code> statement to the table creating query. Your database already exists; you would not want to override existing data.</p><p>Now, we will run <code>php console.php app:migration --init</code> command to initialize our local database. Do not run this command on production!!!</p><p>And your local database structure is ready to use. You can copy your local <code>migratos_migration_versions</code> table to your production database if you want to use that tool in the production server. It contains data for initial data, which is your existing production database. All runs after an initial run will update your database structure from that point. This is zero-point.</p><p>OK!</p><p>Let&rsquo;s create a new migration file. Let&rsquo;s say we need to add an email field to the user table. Run that command: <code>php console.php app:migration -c</code>, and create two empty files, one for up and one for down scripts. Under migration folder <code>d_1660740441.sql u_1660740441.sql</code>, you will see two new files.</p><p>Add your up SQL script to u_1660740441.sql file;</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>ALTER TABLE users ADD COLUMN email varchar(255) null;
</span></span></code></pre></div><p>And add your down SQL script to d_1660740441.sql file;</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>ALTER TABLE users DROP COLUMN email;
</span></span></code></pre></div><p>Ready, you can run the migration command <code>php console.php app:migration -u</code> to append changes to the database. It will print out SQL statements before running on the database.</p><p>Then changes will be applied to your database. You can commit that file, and all developers in the team can create their own migration files, and the system admin will know which changes happened to the database structure.</p><p>Do you want to roll back changes? Easy peasy!</p><p><code>php console.php app:migration -d 1660740441</code> this command will revert changes made by u_1660740441.sql file and upper versions. For instance, you have 2 migration files u_1 and u_2. If you run down the command for 1, it reverts all updates bigger than 1.</p><p>Good for you!</p><p>There is a demo repository in GitHub; <a href=https://github.com/delirehberi/legacy-app>https://github.com/delirehberi/legacy-app</a></p><p>#php #library #database #command #en</p></section><div class=post-tags></div></div></div></article></main><footer><div style=display:flex><a class=soc href=https://github.com/ozgurvurgun rel=me title=GitHub><i data-feather=github></i></a>
<a class=border></a><a class=soc href=https://linkedin.com/in/ozgurvurgun1 rel=me title=Linkedin><i data-feather=linkedin></i></a>
<a class=border></a><a class=soc href=http://emre.xyz/me.vcf rel=me title=VCF><i data-feather=phone></i></a>
<a class=border></a><a class=soc href=http://emre.xyz/resume.pdf rel=me title=Resume><i data-feather=file-text></i></a>
<a class=border></a></div><div class=footer-info>2025 ozgurvurgun | <a href=https://github.com/athul/archie>Archie Theme</a> | Built with <a href=https://gohugo.io>Hugo</a></div></footer><script>feather.replace()</script></div></body></html>